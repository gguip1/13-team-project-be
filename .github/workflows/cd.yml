# =============================================================================
# Spring Boot Backend CD Pipeline
# =============================================================================
# íŠ¸ë¦¬ê±°: CI ì™„ë£Œ í›„ (main ë¸Œëžœì¹˜ë§Œ)
# ìˆœì„œ: ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ â†’ ë°±ì—… â†’ ë°°í¬ â†’ Smoke Test â†’ ì•Œë¦¼
# =============================================================================
# test ìš©ìž„

name: Backend CD

on:
  workflow_run:
    workflows: ["Backend CI"]
    types: [completed]
    branches: [main]

env:
  JAR_NAME: app.jar
  DEPLOY_PATH: /home/ubuntu/app
  BACKUP_PATH: /home/ubuntu/app/backup

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ===== Stage 1: ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ =====
      - name: Download JAR Artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: application-jar
          path: ./artifact

      # ===== SSH ì„¤ì • =====
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ===== Stage 2: ì„œë²„ ë°±ì—… =====
      - name: Backup Current JAR
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            mkdir -p ${{ env.BACKUP_PATH }}

            if [ -f "${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }}" ]; then
              cp ${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }} ${{ env.BACKUP_PATH }}/${{ env.JAR_NAME }}.backup
              echo "ë°±ì—… ì™„ë£Œ"
            else
              echo "ë°±ì—…í•  JAR ì—†ìŒ (ìµœì´ˆ ë°°í¬)"
            fi
          EOF

      # ===== Stage 3: íŒŒì¼ ì „ì†¡ ë° ë°°í¬ =====
      - name: Upload New JAR
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
          scp -i ~/.ssh/deploy_key \
            ./artifact/*.jar \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }}

      - name: Deploy Application
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            cd ${{ env.DEPLOY_PATH }}
            
            # Restart Service (env.conf already exists)
            echo "ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘..."
            sudo systemctl restart moyeobab-api

            # Check status
            if systemctl is-active --quiet moyeobab-api; then
              echo "ë°°í¬ ì™„ë£Œ - ì„œë¹„ìŠ¤ ì‹¤í–‰ ì¤‘"
            else
              echo "ë°°í¬ ì‹¤íŒ¨ - ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‹¤íŒ¨"
              systemctl status moyeobab-api --no-pager
              exit 1
            fi
          EOF

      # ===== Stage 4: Smoke Test =====
      - name: Smoke Test
        id: smoke_test
        run: |
          MAX_RETRY=10
          RETRY_INTERVAL=5

          for i in $(seq 1 $MAX_RETRY);
          do
            echo "Smoke Test $i/$MAX_RETRY..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{{http_code}}" \
              --max-time 10 \
              https://api.moyeobab.com/actuator/health || echo "000")

            echo "HTTP Code: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "503" ]; then
              echo "Smoke Test í†µê³¼ (HTTP: $HTTP_CODE)"
              exit 0
            fi

            sleep $RETRY_INTERVAL
          done

          echo "Smoke Test ì‹¤íŒ¨"
          exit 1

      # ===== ìžë™ ë¡¤ë°± (Smoke Test ì‹¤íŒ¨ ì‹œ) =====
      - name: Rollback on Failure
        if: failure() && steps.smoke_test.outcome == 'failure'
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            cd ${{ env.DEPLOY_PATH }}

            if [ -f "${{ env.BACKUP_PATH }}/${{ env.JAR_NAME }}.backup" ]; then
              echo "ë¡¤ë°± ì‹œìž‘..."
              # Stop service
              sudo systemctl stop moyeobab-api
              
              # Restore file
              cp ${{ env.BACKUP_PATH }}/${{ env.JAR_NAME }}.backup ${{ env.DEPLOY_PATH }}/${{ env.JAR_NAME }}

              # Restart service
              sudo systemctl start moyeobab-api

              echo "ë¡¤ë°± ì™„ë£Œ"
            else
              echo "ë°±ì—… íŒŒì¼ ì—†ìŒ (ìµœì´ˆ ë°°í¬)"
            fi
          EOF

            # ===== Stage 5: ì•Œë¦¼ =====
            - name: Notify Success
              if: success()
              env:
                DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
                TITLE: "ðŸš€ ë°°í¬ ì„±ê³µ: moyeobab-api"
                DESCRIPTION: "ìƒˆë¡œìš´ ë²„ì „ì´ EC2 ì„œë²„ì— ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                COLOR: 3066993
                URL: ${{ github.event.workflow_run.html_url }}
                COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
                AUTHOR: ${{ github.event.workflow_run.head_commit.author.name }}
                RUN_NUM: ${{ github.event.workflow_run.run_number }}
              run: |
                TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
                
                jq -n \
                  --arg title "$TITLE" \
                  --arg desc "$DESCRIPTION" \
                  --arg url "$URL" \
                  --arg color "$COLOR" \
                  --arg msg "$COMMIT_MSG" \
                  --arg author "$AUTHOR" \
                  --arg run_num "$RUN_NUM" \
                  --arg ts "$TIMESTAMP" \
                  '{
                    username: "Moyeobab Deploy Bot",
                    avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                    embeds: [{
                      title: $title,
                      url: $url,
                      description: $desc,
                      color: ($color | tonumber),
                      fields: [
                        {name: "ðŸŒ¿ ë¸Œëžœì¹˜", value: "main", inline: true},
                        {name: "ðŸ”¢ ë¹Œë“œ ë²ˆí˜¸", value: ("#" + $run_num), inline: true},
                        {name: "ðŸ‘¤ ìž‘ì„±ìž", value: $author, inline: true},
                        {name: "ðŸ“ ì»¤ë°‹ ë©”ì‹œì§€", value: $msg, inline: false}
                      ],
                      footer: {
                        text: "Powered by Systemd & Github Actions",
                        icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                      },
                      timestamp: $ts
                    }]
                  }' > payload.json
      
                curl -H "Content-Type: application/json" \
                  -d @payload.json \
                  "$DISCORD_WEBHOOK"
            - name: Notify Failure
              if: failure()
              env:
                DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
                TITLE: "âŒ ë°°í¬ ì‹¤íŒ¨ (ë¡¤ë°± ì™„ë£Œ)"
                DESCRIPTION: "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ **ìžë™ ë¡¤ë°±**ì´ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ëŠ” ì´ì „ ì•ˆì • ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                COLOR: 15158332
                URL: ${{ github.event.workflow_run.html_url }}
                COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
                AUTHOR: ${{ github.event.workflow_run.head_commit.author.name }}
                RUN_NUM: ${{ github.event.workflow_run.run_number }}
              run: |
                TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
                
                jq -n \
                  --arg title "$TITLE" \
                  --arg desc "$DESCRIPTION" \
                  --arg url "$URL" \
                  --arg color "$COLOR" \
                  --arg msg "$COMMIT_MSG" \
                  --arg author "$AUTHOR" \
                  --arg run_num "$RUN_NUM" \
                  --arg ts "$TIMESTAMP" \
                  '{
                    username: "Moyeobab Deploy Bot",
                    avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                    embeds: [{
                      title: $title,
                      url: $url,
                      description: $desc,
                      color: ($color | tonumber),
                      fields: [
                        {name: "ðŸŒ¿ ë¸Œëžœì¹˜", value: "main", inline: true},
                        {name: "ðŸ”¢ ë¹Œë“œ ë²ˆí˜¸", value: ("#" + $run_num), inline: true},
                        {name: "ðŸ‘¤ ìž‘ì„±ìž", value: $author, inline: true},
                        {name: "ðŸ“ ì»¤ë°‹ ë©”ì‹œì§€", value: $msg, inline: false},
                        {name: "ðŸ” ë¡œê·¸ í™•ì¸", value: ("[Github Actions ë°”ë¡œê°€ê¸°](" + $url + ")"), inline: false}
                      ],
                      footer: {
                        text: "Powered by Systemd & Github Actions",
                        icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                      },
                      timestamp: $ts
                    }]
                  }' > payload.json
      
                curl -H "Content-Type: application/json" \
                  -d @payload.json \
                  "$DISCORD_WEBHOOK"